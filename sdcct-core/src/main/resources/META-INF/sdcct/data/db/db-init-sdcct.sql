/*==============================================================================
= DATABASE SETTINGS
==============================================================================*/
set database sql syntax PGS true;

set database default table type cached;

/*==============================================================================
= USERS
==============================================================================*/
create user "${sdcct.data.db.user.main.name}" password '${sdcct.data.db.user.main.pass}';

/*====================================================================================================
= SEQUENCES
=====================================================================================================*/
create sequence revision_id as bigint start with 1;

grant usage on sequence revision_id to "${sdcct.data.db.user.main.name}";

create sequence search_param_id as bigint start with 1;

grant usage on sequence search_param_id to "${sdcct.data.db.user.main.name}";

create sequence resource_id as bigint start with 1;

grant usage on sequence resource_id to "${sdcct.data.db.user.main.name}";

/*====================================================================================================
= TABLES
=====================================================================================================*/
create table revision (
    id bigint generated by default as sequence revision_id primary key,
    timestamp timestamp with time zone not null
);

grant select, insert on table revision to "${sdcct.data.db.user.main.name}";

create table search_param_date (
    id bigint generated by default as sequence search_param_id primary key,
    resource_id bigint not null,
    resource_version bigint not null,
    type varchar(64) not null,
    name varchar(64) not null,
    value_start timestamp with time zone,
    value_end timestamp with time zone
);

grant select, insert, update, delete on table search_param_date to "${sdcct.data.db.user.main.name}";

create table search_param_number (
    id bigint generated by default as sequence search_param_id primary key,
    resource_id bigint not null,
    resource_version bigint not null,
    type varchar(64) not null,
    name varchar(64) not null,
    value decimal not null
);

grant select, insert, update, delete on table search_param_number to "${sdcct.data.db.user.main.name}";

create table search_param_quantity (
    id bigint generated by default as sequence search_param_id primary key,
    resource_id bigint not null,
    resource_version bigint not null,
    type varchar(64) not null,
    name varchar(64) not null,
    code_system_uri varchar(1024),
    code_system_version varchar(64),
    units varchar(128),
    display_name varchar(256),
    value decimal not null
);

grant select, insert, update, delete on table search_param_quantity to "${sdcct.data.db.user.main.name}";

create table search_param_ref (
    id bigint generated by default as sequence search_param_id primary key,
    resource_id bigint not null,
    resource_version bigint not null,
    type varchar(64) not null,
    name varchar(64) not null,
    value varchar(1024) not null
);

grant select, insert, update, delete on table search_param_ref to "${sdcct.data.db.user.main.name}";

create table search_param_string (
    id bigint generated by default as sequence search_param_id primary key,
    resource_id bigint not null,
    resource_version bigint not null,
    type varchar(64) not null,
    name varchar(64) not null,
    value clob(1048576) not null
);

grant select, insert, update, delete on table search_param_string to "${sdcct.data.db.user.main.name}";

create table search_param_token (
    id bigint generated by default as sequence search_param_id primary key,
    resource_id bigint not null,
    resource_version bigint not null,
    type varchar(64) not null,
    name varchar(64) not null,
    code_system_uri varchar(1024),
    code_system_version varchar(64),
    display_name varchar(256),
    value varchar(128) not null
);

grant select, insert, update, delete on table search_param_token to "${sdcct.data.db.user.main.name}";

create table search_param_uri (
    id bigint generated by default as sequence search_param_id primary key,
    resource_id bigint not null,
    resource_version bigint not null,
    type varchar(64) not null,
    name varchar(64) not null,
    value varchar(1024) not null
);

grant select, insert, update, delete on table search_param_uri to "${sdcct.data.db.user.main.name}";

create table resource (
    id bigint generated by default as sequence resource_id primary key,
    version bigint not null,
    spec_type varchar(64) not null,
    type varchar(64) not null,
    content clob(10485760) not null,
    text clob(10485760)
);

grant select, insert, update, delete on table resource to "${sdcct.data.db.user.main.name}";

create table resource_history (
    revision_id bigint not null,
    revision_type tinyint not null,
    revision_end_id bigint,
    revision_end_timestamp timestamp with time zone,
    id bigint not null,
    version bigint,
    spec_type varchar(64) not null,
    type varchar(64),
    content clob(10485760),
    text clob(10485760),
    primary key (id, revision_id)
);

grant select, insert, update on table resource_history to "${sdcct.data.db.user.main.name}";
